// esdb v0.1.0
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e=e||self).esdb={})}(this,function(e){"use strict";function t(e,t){return e(t={exports:{}},t.exports),t.exports}var E=t(function(e){var t=function(a){var u,e=Object.prototype,f=e.hasOwnProperty,t="function"==typeof Symbol?Symbol:{},o=t.iterator||"@@iterator",n=t.asyncIterator||"@@asyncIterator",r=t.toStringTag||"@@toStringTag";function c(e,t,n,r){var i,a,c,u,o=t&&t.prototype instanceof m?t:m,s=Object.create(o.prototype),f=new N(r||[]);return s._invoke=(i=e,a=n,c=f,u=h,function(e,t){if(u===v)throw new Error("Generator is already running");if(u===y){if("throw"===e)throw t;return S()}for(c.method=e,c.arg=t;;){var n=c.delegate;if(n){var r=E(n,c);if(r){if(r===d)continue;return r}}if("next"===c.method)c.sent=c._sent=c.arg;else if("throw"===c.method){if(u===h)throw u=y,c.arg;c.dispatchException(c.arg)}else"return"===c.method&&c.abrupt("return",c.arg);u=v;var o=l(i,a,c);if("normal"===o.type){if(u=c.done?y:p,o.arg===d)continue;return{value:o.arg,done:c.done}}"throw"===o.type&&(u=y,c.method="throw",c.arg=o.arg)}}),s}function l(e,t,n){try{return{type:"normal",arg:e.call(t,n)}}catch(e){return{type:"throw",arg:e}}}a.wrap=c;var h="suspendedStart",p="suspendedYield",v="executing",y="completed",d={};function m(){}function i(){}function s(){}var k={};k[o]=function(){return this};var x=Object.getPrototypeOf,g=x&&x(x(I([])));g&&g!==e&&f.call(g,o)&&(k=g);var w=s.prototype=m.prototype=Object.create(k);function b(e){["next","throw","return"].forEach(function(t){e[t]=function(e){return this._invoke(t,e)}})}function P(u,s){var t;this._invoke=function(n,r){function e(){return new s(function(e,t){!function t(e,n,r,o){var i=l(u[e],u,n);if("throw"!==i.type){var a=i.arg,c=a.value;return c&&"object"==typeof c&&f.call(c,"__await")?s.resolve(c.__await).then(function(e){t("next",e,r,o)},function(e){t("throw",e,r,o)}):s.resolve(c).then(function(e){a.value=e,r(a)},function(e){return t("throw",e,r,o)})}o(i.arg)}(n,r,e,t)})}return t=t?t.then(e,e):e()}}function E(e,t){var n=e.iterator[t.method];if(n===u){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=u,E(e,t),"throw"===t.method))return d;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return d}var r=l(n,e.iterator,t.arg);if("throw"===r.type)return t.method="throw",t.arg=r.arg,t.delegate=null,d;var o=r.arg;return o?o.done?(t[e.resultName]=o.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=u),t.delegate=null,d):o:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,d)}function O(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function L(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function N(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(O,this),this.reset(!0)}function I(t){if(t){var e=t[o];if(e)return e.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var n=-1,r=function e(){for(;++n<t.length;)if(f.call(t,n))return e.value=t[n],e.done=!1,e;return e.value=u,e.done=!0,e};return r.next=r}}return{next:S}}function S(){return{value:u,done:!0}}return i.prototype=w.constructor=s,s.constructor=i,s[r]=i.displayName="GeneratorFunction",a.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===i||"GeneratorFunction"===(t.displayName||t.name))},a.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,s):(e.__proto__=s,r in e||(e[r]="GeneratorFunction")),e.prototype=Object.create(w),e},a.awrap=function(e){return{__await:e}},b(P.prototype),P.prototype[n]=function(){return this},a.AsyncIterator=P,a.async=function(e,t,n,r,o){void 0===o&&(o=Promise);var i=new P(c(e,t,n,r),o);return a.isGeneratorFunction(t)?i:i.next().then(function(e){return e.done?e.value:i.next()})},b(w),w[r]="Generator",w[o]=function(){return this},w.toString=function(){return"[object Generator]"},a.keys=function(n){var r=[];for(var e in n)r.push(e);return r.reverse(),function e(){for(;r.length;){var t=r.pop();if(t in n)return e.value=t,e.done=!1,e}return e.done=!0,e}},a.values=I,N.prototype={constructor:N,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=u,this.done=!1,this.delegate=null,this.method="next",this.arg=u,this.tryEntries.forEach(L),!e)for(var t in this)"t"===t.charAt(0)&&f.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=u)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(n){if(this.done)throw n;var r=this;function e(e,t){return i.type="throw",i.arg=n,r.next=e,t&&(r.method="next",r.arg=u),!!t}for(var t=this.tryEntries.length-1;0<=t;--t){var o=this.tryEntries[t],i=o.completion;if("root"===o.tryLoc)return e("end");if(o.tryLoc<=this.prev){var a=f.call(o,"catchLoc"),c=f.call(o,"finallyLoc");if(a&&c){if(this.prev<o.catchLoc)return e(o.catchLoc,!0);if(this.prev<o.finallyLoc)return e(o.finallyLoc)}else if(a){if(this.prev<o.catchLoc)return e(o.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return e(o.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;0<=n;--n){var r=this.tryEntries[n];if(r.tryLoc<=this.prev&&f.call(r,"finallyLoc")&&this.prev<r.finallyLoc){var o=r;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var i=o?o.completion:{};return i.type=e,i.arg=t,o?(this.method="next",this.next=o.finallyLoc,d):this.complete(i)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),d},finish:function(e){for(var t=this.tryEntries.length-1;0<=t;--t){var n=this.tryEntries[t];if(n.finallyLoc===e)return this.complete(n.completion,n.afterLoc),L(n),d}},catch:function(e){for(var t=this.tryEntries.length-1;0<=t;--t){var n=this.tryEntries[t];if(n.tryLoc===e){var r=n.completion;if("throw"===r.type){var o=r.arg;L(n)}return o}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,n){return this.delegate={iterator:I(e),resultName:t,nextLoc:n},"next"===this.method&&(this.arg=u),d}},a}(e.exports);try{regeneratorRuntime=t}catch(e){Function("r","regeneratorRuntime = r")(t)}});function u(e,t,n,r,o,i,a){try{var c=e[i](a),u=c.value}catch(e){return void n(e)}c.done?t(u):Promise.resolve(u).then(r,o)}var h=function(c){return function(){var e=this,a=arguments;return new Promise(function(t,n){var r=c.apply(e,a);function o(e){u(r,t,n,o,i,"next",e)}function i(e){u(r,t,n,o,i,"throw",e)}o(void 0)})}},p=t(function(t){function n(e){return"function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?t.exports=n=function(e){return typeof e}:t.exports=n=function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},n(e)}t.exports=n});var v=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")};function r(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var i=function(e,t,n){return t&&r(e.prototype,t),n&&r(e,n),e},o={},n=function(){function t(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:20;v(this,t),this.mockDelay=e}return i(t,[{key:"init",value:function(){return Promise.resolve()}},{key:"getItem",value:function(t){var n=this;return new Promise(function(e){setTimeout(function(){e(o[t]||null)},n.mockDelay)})}},{key:"setItem",value:function(t,n){var r=this;return new Promise(function(e){setTimeout(function(){o[t]=n,e(n)},r.mockDelay)})}},{key:"removeItem",value:function(n){var e=this;return new Promise(function(t){setTimeout(function(){var e=null;o.hasOwnProperty(n)&&(e=o[n],delete o[n]),t(e)},e.mockDelay)})}},{key:"clearAllItems",value:function(){var t=this;return new Promise(function(e){setTimeout(function(){o={},e()},t.mockDelay)})}}]),t}(),a=function(){function e(){v(this,e)}return i(e,[{key:"encrypt",value:function(e){return JSON.stringify(e)}},{key:"decrypt",value:function(e){return JSON.parse(e)}}]),e}(),O=function(){function s(e){var t=e.name,n=void 0===t?"":t,r=e.store,o=void 0===r?null:r,i=e.encryption,a=void 0===i?null:i,c=e.options,u=void 0===c?{}:c;v(this,s),this.name=n,this.store=o,this.encryption=a,this.config={blockSize:u.blockSize||64,batchSize:u.batchSize||128,batchInterval:u.batchInterval||200}}return i(s,[{key:"get",value:function(){return new Promise(function(e,t){})}},{key:"getAll",value:function(){return new Promise(function(e,t){})}},{key:"each",value:function(){return new Promise(function(e,t){})}},{key:"count",value:function(){return new Promise(function(e,t){})}},{key:"set",value:function(){return new Promise(function(e,t){})}},{key:"remove",value:function(){return new Promise(function(e,t){})}},{key:"clear",value:function(){return new Promise(function(e,t){})}}]),s}(),L=function(){function e(){v(this,e)}return i(e,null,[{key:"log",value:function(){var e;(e=console).log.apply(e,arguments)}},{key:"warning",value:function(){var e;(e=console).warning.apply(e,arguments)}},{key:"error",value:function(){var e;(e=console).error.apply(e,arguments)}}]),e}(),y=function(){function n(e){v(this,n),this.conditions=e}return i(n,[{key:"getRelatedColumns",value:function(){var e=[];for(var t in this.conditions)[n.Command.AND,n.Command.OR].indexOf(t)?Array.isArray(this.conditions[t]):e.push(t);return e}},{key:"match",value:function(e){return function e(t,n){try{for(var r in n)if(r===y.Command.AND){if(!Array.isArray(n[r]))throw b.invalidParams("Query syntax error with ".concat(r));for(var o in n[r])if(!e(t,n[r][o]))return!1}else if(r===y.Command.OR){if(!Array.isArray(n[r]))throw b.invalidParams("Query syntax error with ".concat(r));var i=0;for(var a in n[r])e(t,n[r][a])&&i++;if(0===i)return!1}else{var c=n[r];if("object"===p(c)&&c)for(var u in c)switch(u){case y.Command.GT:if("number"==typeof t[r]){if(!(t[r]>c[u]))return!1}else{if("string"!=typeof t[r])return!1;if(!(0<t[r].localeCompare(c[u])))return!1}break;case y.Command.GTE:if("number"==typeof t[r]){if(!(t[r]>=c[u]))return!1}else{if("string"!=typeof t[r])return!1;if(!(0<=t[r].localeCompare(c[u])))return!1}break;case y.Command.LT:if("number"==typeof t[r]){if(!(t[r]<c[u]))return!1}else{if("string"!=typeof t[r])return!1;if(!(t[r].localeCompare(c[u])<0))return!1}break;case y.Command.LTE:if("number"==typeof t[r]){if(!(t[r]<=c[u]))return!1}else{if("string"!=typeof t[r])return!1;if(!(t[r].localeCompare(c[u])<=0))return!1}break;case y.Command.EQ:if(t[r]!==c[u])return!1;break;case y.Command.NEQ:if(t[r]===c[u])return!1;break;case y.Command.IN:if(!Array.isArray(c[u]))throw b.invalidParams("Query syntax error with ".concat(r));if(!(0<=c[u].indexOf(t[r])))return!1;break;case y.Command.NOT_IN:if(!Array.isArray(c[u]))throw b.invalidParams("Query syntax error with ".concat(r));if(!(c[u].indexOf(t[r])<0))return!1;break;case y.Command.LIKE:if("string"!=typeof c[u])throw b.invalidParams("Query syntax error with ".concat(r));if(!(0<=c[u].indexOf(t[r])))return!1;break;case y.Command.NOT_LIKE:if("string"!=typeof c[u])throw b.invalidParams("Query syntax error with ".concat(r));if(!(c[u].indexOf(t[r])<0))return!1;break;case y.Command.REGEX:if(!(c[u]instanceof RegExp))throw b.invalidParams("Query syntax error with ".concat(r));if(!c[u].test(t[r]))return!1;break;case y.Command.WHERE:if("function"!=typeof c[u])throw b.invalidParams("Query syntax error with ".concat(r));if(!c[u](t[r]))return!1;break;default:return!1}else if(t[r]!==c)return!1}return!0}catch(e){return L.error(e.message),!1}}(e,this.conditions)}}],[{key:"Command",get:function(){return{AND:"/and",OR:"/or",GT:">",GTE:">=",LT:"<",LTE:"<=",EQ:"=",NEQ:"!=",IN:"/in",NOT_IN:"/nin",LIKE:"/like",NOT_LIKE:"/nlike",REGEX:"/regex",WHERE:"/where"}}}]),n}(),N=function(){function c(e){var t=e.collectionName,n=void 0===t?"":t,r=e.kernel,o=void 0===r?null:r,i=e.indexes,a=void 0===i?[]:i;v(this,c),this.collectionName=n,this.kernel=o,this.indexes=a}var t;return i(c,[{key:"indexToKey",value:function(e){return e.join(">")}},{key:"indexFromKey",value:function(e){return e.split(">")}},{key:"findBestIndexForQuery",value:function(e,t){var n=1<arguments.length&&void 0!==t?t:{};if(e instanceof y&&"object"===p(n)&&null!==n){var r=e.getRelatedColumns(),o=[];for(var i in this.indexes){var a=this.indexes[i].map(function(e){return e.replace(/^--/,"")}),c=0,u=1;for(var s in a){var f=a[s];0<=r.indexOf(f)?c+=u:u*=.2}0<a.length&&a[a.length-1]===n.orderBy&&(u+=2*Math.sqrt(a.length)/a.length),0<c&&o.push({index:this.indexes[i],score:c})}var l=o.sort(function(e,t){return t.score-e.score});return 0<l.length?l[0]:null}return null}},{key:"replace",value:(t=h(E.mark(function e(t){var n,r,o,i,a,c,u,s,f,l,h=this;return E.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:for(n=[],r=[],o=function(e,t){return e.localeCompare(t)},i=this.indexes.map(function(e){return h.indexToKey(e)}).sort(o),a=t.map(function(e){return h.indexToKey(e)}).sort(o),u=c=0;c<i.length||u<a.length;)s=i[c]||null,f=a[u]||null,s&&f?0===(l=o(s,f))?(c++,u++):0<l?(n.push(f),u++):(r.push(s),c++):s?(r.push(s),c++):f&&(n.push(f),u++);this.indexes=t;case 9:case"end":return e.stop()}},e,this)})),function(e){return t.apply(this,arguments)})}]),c}();var c=function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e};var s=function(e,t){return!t||"object"!==p(t)&&"function"!=typeof t?c(e):t},f=t(function(t){function n(e){return t.exports=n=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},n(e)}t.exports=n}),l=t(function(n){function r(e,t){return n.exports=r=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},r(e,t)}n.exports=r});var d=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&l(e,t)};var m=function(e){return-1!==Function.toString.call(e).indexOf("[native code]")};var k=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}},x=t(function(r){function o(e,t,n){return k()?r.exports=o=Reflect.construct:r.exports=o=function(e,t,n){var r=[null];r.push.apply(r,t);var o=new(Function.bind.apply(e,r));return n&&l(o,n.prototype),o},o.apply(null,arguments)}r.exports=o});function g(r){return function(){var e,t=f(r);if(function(){if("undefined"==typeof Reflect||!Reflect.construct)return;if(Reflect.construct.sham)return;if("function"==typeof Proxy)return 1;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),1}catch(e){return}}()){var n=f(this).constructor;e=Reflect.construct(t,arguments,n)}else e=t.apply(this,arguments);return s(this,e)}}function w(e){return JSON.parse(JSON.stringify(e))}var b=function(e){d(o,e);var r=g(o);function o(e,t){var n;return v(this,o),(n=r.call(this,e)).code=t,n}return i(o,null,[{key:"immutableReadyState",value:function(){return new o("Can't change database after getting ready.",700010)}},{key:"databaseNotReady",value:function(){return new o("Database is not ready.",700011)}},{key:"kernelNotLoaded",value:function(){return new o("Database kernel is not loaded.",700012)}},{key:"invalidParams",value:function(e){return new o("Invalid parameters: ".concat(0<arguments.length&&void 0!==e?e:"unknown"),703e3)}},{key:"dataNotFound",value:function(){return new o("Data not found.",704e3)}},{key:"dataAlreadyExists",value:function(){return new o("Data already exists.",709e3)}}]),o}(t(function(t){function r(e){var n="function"==typeof Map?new Map:void 0;return t.exports=r=function(e){if(null===e||!m(e))return e;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==n){if(n.has(e))return n.get(e);n.set(e,t)}function t(){return x(e,arguments,f(this).constructor)}return t.prototype=Object.create(e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),l(t,e)},r(e)}t.exports=r})(Error)),P=function(){function e(){v(this,e),this.queue=[],this.locked=!1}return i(e,[{key:"lock",value:function(e){var t=this;this.locked?this.queue.push(e):(this.locked=!0,e(function(){return t.unlock()}))}},{key:"unlock",value:function(){if(this.locked&&(this.locked=!1,0<this.queue.length)){var e=this.queue.shift();this.lock(e)}}}]),e}(),I=new WeakMap,S=function(){function l(e){var t=e.name,n=void 0===t?"":t,r=e.key,o=void 0===r?"":r,i=e.model,a=void 0===i?null:i,c=e.indexer,u=void 0===c?null:c,s=e.kernel,f=void 0===s?null:s;v(this,l),I.set(this,{name:n,key:o,model:a,indexer:u,kernel:f,mutex:new P})}return i(l,[{key:"get",value:function(i){var a=this;return new Promise(function(n,r){if("string"==typeof i){var e=I.get(a),o=e.kernel,t=e.mutex;o?t.lock(function(){var t=h(E.mark(function e(t){return E.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.t0=n,e.next=4,o.get(a.name,i);case 4:e.t1=e.sent,(0,e.t0)(e.t1),e.next=11;break;case 8:e.prev=8,e.t2=e.catch(0),r(e.t2);case 11:return e.prev=11,t(),e.finish(11);case 14:case"end":return e.stop()}},e,null,[[0,8,11,14]])}));return function(e){return t.apply(this,arguments)}}()):r(b.kernelNotLoaded())}else r(b.invalidParams("collection.get(".concat(i,")")))})}},{key:"getAll",value:function(s,e){var f=this,l=1<arguments.length&&void 0!==e?e:{};return new Promise(function(i,a){if((s instanceof y||null===s)&&"object"===p(l)){var e=I.get(f),c=e.kernel,u=e.indexer,t=e.mutex;c?t.lock(function(){var t=h(E.mark(function e(t){var r,n,o;return E.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,!u.findBestIndexForQuery(s,l)){e.next=5;break}e.next=12;break;case 5:return r=[],e.next=8,c.each(f.name,function(){var n=h(E.mark(function e(t,n){return E.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:s&&!s.match(n)||r.push(n);case 1:case"end":return e.stop()}},e)}));return function(e,t){return n.apply(this,arguments)}}());case 8:l.orderBy&&(n=l.orderBy.replace(/^--/,""),o=/^--/.test(l.orderBy),r=r.sort(function(e,t){return o?t[n]-e[n]:e[n]-t[n]})),l.offset&&(r=r.slice(l.offset)),l.limit&&(r=r.slice(0,l.limit)),i(r);case 12:e.next=17;break;case 14:e.prev=14,e.t0=e.catch(0),a(e.t0);case 17:return e.prev=17,t(),e.finish(17);case 20:case"end":return e.stop()}},e,null,[[0,14,17,20]])}));return function(e){return t.apply(this,arguments)}}()):a(b.kernelNotLoaded())}else a(b.invalidParams("collection.getAll()"))})}},{key:"count",value:function(a){var c=this;return new Promise(function(n,o){if(a instanceof y){var e=I.get(c),i=e.kernel,t=e.mutex;i?t.lock(function(){var t=h(E.mark(function e(t){var r;return E.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,a)return r=0,e.next=5,i.each(c.name,function(){var n=h(E.mark(function e(t,n){return E.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:a.match(n)&&r++;case 1:case"end":return e.stop()}},e)}));return function(e,t){return n.apply(this,arguments)}}());e.next=8;break;case 5:n(r),e.next=13;break;case 8:return e.t0=n,e.next=11,i.count(c.name);case 11:e.t1=e.sent,(0,e.t0)(e.t1);case 13:e.next=18;break;case 15:e.prev=15,e.t2=e.catch(0),o(e.t2);case 18:return e.prev=18,t(),e.finish(18);case 21:case"end":return e.stop()}},e,null,[[0,15,18,21]])}));return function(e){return t.apply(this,arguments)}}()):o(b.kernelNotLoaded())}else o(b.invalidParams("collection.count()"))})}},{key:"insert",value:function(i){var a=this;return new Promise(function(n,r){if("object"===p(i)&&null!==i&&i.hasOwnProperty(a.key)){var e=I.get(a),o=e.kernel,t=e.mutex;o?t.lock(function(){var t=h(E.mark(function e(t){return E.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,o.get(a.name,i[a.key],i);case 3:if(e.sent){e.next=12;break}return e.t0=n,e.next=8,o.set(a.name,i[a.key],i);case 8:e.t1=e.sent,(0,e.t0)(e.t1),e.next=13;break;case 12:throw b.dataAlreadyExists();case 13:e.next=18;break;case 15:e.prev=15,e.t2=e.catch(0),r(e.t2);case 18:return e.prev=18,t(),e.finish(18);case 21:case"end":return e.stop()}},e,null,[[0,15,18,21]])}));return function(e){return t.apply(this,arguments)}}()):r(b.kernelNotLoaded())}else r(b.invalidParams("collection.insert(".concat(i,")")))})}},{key:"upsert",value:function(i){var a=this;return new Promise(function(n,r){if("object"===p(i)&&null!==i&&i.hasOwnProperty(a.key)){var e=I.get(a),o=e.kernel,t=e.mutex;o?t.lock(function(){var t=h(E.mark(function e(t){return E.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.t0=n,e.next=4,o.set(a.name,i[a.key],i);case 4:e.t1=e.sent,(0,e.t0)(e.t1),e.next=11;break;case 8:e.prev=8,e.t2=e.catch(0),r(e.t2);case 11:return e.prev=11,t(),e.finish(11);case 14:case"end":return e.stop()}},e,null,[[0,8,11,14]])}));return function(e){return t.apply(this,arguments)}}()):r(b.kernelNotLoaded())}else r(b.invalidParams("collection.upsert(".concat(i,")")))})}},{key:"update",value:function(i){var a=this;return new Promise(function(n,r){if("object"===p(i)&&null!==i&&i.hasOwnProperty(a.key)){var e=I.get(a),o=e.kernel,t=e.mutex;o?t.lock(function(){var t=h(E.mark(function e(t){return E.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,o.get(a.name,i[a.key],i);case 3:if(e.sent)return e.t0=n,e.next=8,o.set(a.name,i[a.key],i);e.next=12;break;case 8:e.t1=e.sent,(0,e.t0)(e.t1),e.next=13;break;case 12:throw b.dataNotFound();case 13:e.next=18;break;case 15:e.prev=15,e.t2=e.catch(0),r(e.t2);case 18:return e.prev=18,t(),e.finish(18);case 21:case"end":return e.stop()}},e,null,[[0,15,18,21]])}));return function(e){return t.apply(this,arguments)}}()):r(b.kernelNotLoaded())}else r(b.invalidParams("collection.update(".concat(i,")")))})}},{key:"remove",value:function(i){var a=this;return new Promise(function(n,r){if("string"==typeof i){var e=I.get(a),o=e.kernel,t=e.mutex;o?t.lock(function(){var t=h(E.mark(function e(t){return E.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.t0=n,e.next=4,o.remove(a.name,i);case 4:e.t1=e.sent,(0,e.t0)(e.t1),e.next=11;break;case 8:e.prev=8,e.t2=e.catch(0),r(e.t2);case 11:return e.prev=11,t(),e.finish(11);case 14:case"end":return e.stop()}},e,null,[[0,8,11,14]])}));return function(e){return t.apply(this,arguments)}}()):r(b.kernelNotLoaded())}else r(b.invalidParams("collection.remove(".concat(i,")")))})}},{key:"updateIf",value:function(a,c){var u=this;return new Promise(function(n,r){if("object"===p(a)&&null!==a&&c instanceof y){var e=I.get(u),i=e.kernel,t=e.mutex;i?t.lock(function(){var t=h(E.mark(function e(t){var o;return E.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,o=[],e.next=4,i.each(u.name,function(){var n=h(E.mark(function e(t,n){var r;return E.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!c.match(n)){e.next=5;break}for(r in a)n[r]=a[r];return e.next=4,i.set(u.name,t,n);case 4:o.push(n);case 5:case"end":return e.stop()}},e)}));return function(e,t){return n.apply(this,arguments)}}());case 4:n(o),e.next=10;break;case 7:e.prev=7,e.t0=e.catch(0),r(e.t0);case 10:return e.prev=10,t(),e.finish(10);case 13:case"end":return e.stop()}},e,null,[[0,7,10,13]])}));return function(e){return t.apply(this,arguments)}}()):r(b.kernelNotLoaded())}else r(b.invalidParams("collection.updateIf()"))})}},{key:"removeIf",value:function(a){var c=this;return new Promise(function(n,o){if(a instanceof y){var e=I.get(c),i=e.kernel,t=e.mutex;i?t.lock(function(){var t=h(E.mark(function e(t){var r;return E.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,r=[],e.next=4,i.each(c.name,function(){var n=h(E.mark(function e(t,n){return E.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(a.match(n))return e.next=3,i.remove(c.name,t);e.next=4;break;case 3:r.push(n);case 4:case"end":return e.stop()}},e)}));return function(e,t){return n.apply(this,arguments)}}());case 4:n(r),e.next=10;break;case 7:e.prev=7,e.t0=e.catch(0),o(e.t0);case 10:return e.prev=10,t(),e.finish(10);case 13:case"end":return e.stop()}},e,null,[[0,7,10,13]])}));return function(e){return t.apply(this,arguments)}}()):o(b.kernelNotLoaded())}else o(b.invalidParams("collection.removeIf()"))})}},{key:"clear",value:function(){var i=this;return new Promise(function(n,r){var e=I.get(i),o=e.kernel,t=e.mutex;o?t.lock(function(){var t=h(E.mark(function e(t){return E.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,o.clear(i.name);case 3:n(),e.next=9;break;case 6:e.prev=6,e.t0=e.catch(0),r(e.t0);case 9:return e.prev=9,t(),e.finish(9);case 12:case"end":return e.stop()}},e,null,[[0,6,9,12]])}));return function(e){return t.apply(this,arguments)}}()):r(b.kernelNotLoaded())})}},{key:"name",get:function(){return I.get(this).name}},{key:"key",get:function(){return I.get(this).key}},{key:"model",get:function(){var e=I.get(this).model;return w(e)}},{key:"indexes",get:function(){var e=I.get(this).indexer;return w(e.indexes)}}]),l}(),R="esdb-metadata",j=null,T=null,_=new(function(){function e(){return v(this,e),j||(T={name:"",version:1,store:new n,encryption:new a,schema:{},options:{},collection:{},error:null,state:e.State.INIT},j=this),j}var t;return i(e,[{key:"name",value:function(e){return T.error||("string"==typeof e&&e?this.isInit?T.name=e:T.error=b.immutableReadyState():T.error=b.invalidParams("esdb.name(".concat(e,")"))),this}},{key:"version",value:function(e){return T.error||("number"==typeof e&&0<e?this.isInit?T.version=e:T.error=b.immutableReadyState():T.error=b.invalidParams("esdb.version(".concat(e,")"))),this}},{key:"store",value:function(e){return T.error||(e instanceof n?this.isInit?T.store=e:T.error=b.immutableReadyState():T.error=b.invalidParams("esdb.store(".concat(e,")"))),this}},{key:"config",value:function(e){return T.error||("object"===p(e)&&e?this.isInit?T.options=e:T.error=b.immutableReadyState():T.error=b.invalidParams("esdb.config(".concat(e,")"))),this}},{key:"encryption",value:function(e){return T.error||(e instanceof a?this.isInit?T.encryption=e:T.error=b.immutableReadyState():T.error=b.invalidParams("esdb.encryption(".concat(e,")"))),this}},{key:"schema",value:function(e){if(!T.error){var t=e.name,n=e.model,r=e.key,o=e.indexes,i=void 0===o?[]:o,a=e.migrate,c=void 0===a?null:a;"string"==typeof t&&t&&"object"===p(n)&&n&&"string"==typeof r&&r&&Array.isArray(i)&&i.every(function(e){return Array.isArray(e)&&0<e.length&&e.every(function(e){return"string"==typeof e&&n.hasOwnProperty(e)})})&&("function"==typeof c||null===c)?this.isInit?T.schema[t]={model:n,key:r,indexes:i,migrate:c}:T.error=b.immutableReadyState():T.error=b.invalidParams("esdb.schema(".concat(e,")"))}return this}},{key:"build",value:(t=h(E.mark(function e(){var t,n,r,o,i,a,c,u,s,f,l,h,p,v,y,d,m,k,x,g,w,b,P;return E.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(T.error){e.next=66;break}return e.prev=1,t=T.name,n=T.version,r=T.store,o=T.schema,e.next=5,r.init();case 5:return e.next=7,r.getItem(R);case 7:i=e.sent,a=null,c=!1,i&&i.version!==n&&(a=i.version,c=!0),u=new O({name:t,store:r,encryption:T.encryption,options:T.options}),e.t0=E.keys(o);case 13:if((e.t1=e.t0()).done){e.next=57;break}s=e.t1.value,f="".concat("esdb-collection-").concat(s),l=o[s],h=l.model,p=l.key,v=l.indexes,y=l.migrate,d=!1,e.t2=E.keys(v);case 19:if((e.t3=e.t2()).done){e.next=27;break}if(m=e.t3.value,1===(k=v[m]).length&&k[0]===p)return d=!0,e.abrupt("break",27);e.next=25;break;case 25:e.next=19;break;case 27:return d||v.unshift([p]),e.next=30,r.getItem(f);case 30:if(x=e.sent,g=new N({collectionName:s,kernel:u,indexes:x?x.indexes:v}),w=new S({name:s,key:p,model:h,indexer:g,kernel:u}),!x){e.next=52;break}if(!c){e.next=52;break}if(y)return e.next=38,w.getAll();e.next=50;break;case 38:b=e.sent,e.t4=E.keys(b);case 40:if((e.t5=e.t4()).done){e.next=50;break}return P=e.t5.value,e.next=44,y(a,b[P]);case 44:if(e.sent)return e.next=48,w.update(b[P]);e.next=48;break;case 48:e.next=40;break;case 50:return e.next=52,g.replace(v);case 52:return e.next=54,r.setItem(f,{model:h,key:p,indexes:v});case 54:T.collection[s]=w,e.next=13;break;case 57:return e.next=59,r.setItem(R,JSON.stringify({name:t,version:n,schema:o}));case 59:e.next=64;break;case 61:e.prev=61,e.t6=e.catch(1),L.error(e.t6.message);case 64:e.next=67;break;case 66:L.error(T.error.message);case 67:case"end":return e.stop()}},e,null,[[1,61]])})),function(){return t.apply(this,arguments)})},{key:"collection",value:function(e){var t=null;return T.error||(this.isReady?"string"==typeof e&&T.collection.hasOwnProperty(e)&&T.collection[e]instanceof S?t=T.collection[e]:L.error(b.invalidParams("esdb.collection(".concat(e,")"))):L.error(b.databaseNotReady())),t}},{key:"isInit",get:function(){return T.state===e.State.INIT}},{key:"isReady",get:function(){return T.state===e.State.READY}}],[{key:"State",get:function(){return{INIT:"init",READY:"ready"}}}]),e}());e.EsdbEncryption=a,e.EsdbError=b,e.EsdbQuery=y,e.EsdbStore=n,e.default=_,Object.defineProperty(e,"__esModule",{value:!0})});