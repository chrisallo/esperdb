// esdb v1.0.0
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e=e||self).esdb={})}(this,function(e){"use strict";function s(e){return(s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function c(e,t,n,r,o,i,a){try{var u=e[i](a),c=u.value}catch(e){return void n(e)}u.done?t(c):Promise.resolve(c).then(r,o)}function f(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function r(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function n(e,t,n){return t&&r(e.prototype,t),n&&r(e,n),e}function o(e){return(o=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function i(e,t){return(i=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function a(e,t,n){return(a=function(){if("undefined"!=typeof Reflect&&Reflect.construct&&!Reflect.construct.sham){if("function"==typeof Proxy)return 1;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),1}catch(e){return}}}()?Reflect.construct:function(e,t,n){var r=[null];r.push.apply(r,t);var o=new(Function.bind.apply(e,r));return n&&i(o,n.prototype),o}).apply(null,arguments)}function t(e){var r="function"==typeof Map?new Map:void 0;return(t=function(e){if(null===e||(t=e,-1===Function.toString.call(t).indexOf("[native code]")))return e;var t;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==r){if(r.has(e))return r.get(e);r.set(e,n)}function n(){return a(e,arguments,o(this).constructor)}return n.prototype=Object.create(e.prototype,{constructor:{value:n,enumerable:!1,writable:!0,configurable:!0}}),i(n,e)})(e)}function u(e,t){return!t||"object"!=typeof t&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function g(e){var t=e.name,n=void 0===t?"":t,r=e.store,o=void 0===r?null:r,i=e.encryption,a=void 0===i?null:i,u=e.options,c=void 0===u?{}:u;f(this,g),this.name=n,this.store=o,this.encryption=a,this.config={batchSize:c.batchSize||64,batchInterval:c.batchInterval||200,blockSize:c.blockSize||64,blockFlush:c.blockFlush||16}}var l={},y=function(){function t(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:20;f(this,t),this.mockDelay=e}return n(t,[{key:"init",value:function(){return Promise.resolve()}},{key:"getItem",value:function(t){var n=this;return new Promise(function(e){setTimeout(function(){e(l[t]||null)},n.mockDelay)})}},{key:"setItem",value:function(t,n){var r=this;return new Promise(function(e){setTimeout(function(){l[t]=n,e(n)},r.mockDelay)})}},{key:"removeItem",value:function(n){var e=this;return new Promise(function(t){setTimeout(function(){var e=null;l.hasOwnProperty(n)&&(e=l[n],delete l[n]),t(e)},e.mockDelay)})}},{key:"clearAllItems",value:function(){var t=this;return new Promise(function(e){setTimeout(function(){l={},e()},t.mockDelay)})}}]),t}(),m=function(){function e(){f(this,e)}return n(e,[{key:"encrypt",value:function(e){return JSON.stringify(e)}},{key:"decrypt",value:function(e){return JSON.parse(e)}}]),e}(),d=new WeakMap,w=function(){function u(e){var t=e.name,n=void 0===t?"":t,r=e.key,o=void 0===r?"":r,i=e.kernel,a=void 0===i?null:i;f(this,u),this.name=n,this.key=o,d.set(this,a)}return n(u,[{key:"get",value:function(){var n=this;return new Promise(function(e,t){d.get(n)||t(p.kernelNotLoaded())})}},{key:"getAll",value:function(){var n=this;return new Promise(function(e,t){d.get(n)||t(p.kernelNotLoaded())})}},{key:"count",value:function(){var n=this;return new Promise(function(e,t){d.get(n)||t(p.kernelNotLoaded())})}},{key:"insert",value:function(){var n=this;return new Promise(function(e,t){d.get(n)||t(p.kernelNotLoaded())})}},{key:"upsert",value:function(){var n=this;return new Promise(function(e,t){d.get(n)||t(p.kernelNotLoaded())})}},{key:"update",value:function(){var n=this;return new Promise(function(e,t){d.get(n)||t(p.kernelNotLoaded())})}},{key:"remove",value:function(){var n=this;return new Promise(function(e,t){d.get(n)||t(p.kernelNotLoaded())})}},{key:"updateIf",value:function(){var n=this;return new Promise(function(e,t){d.get(n)||t(p.kernelNotLoaded())})}},{key:"removeIf",value:function(){var n=this;return new Promise(function(e,t){d.get(n)||t(p.kernelNotLoaded())})}},{key:"clear",value:function(){var n=this;return new Promise(function(e,t){d.get(n)||t(p.kernelNotLoaded())})}}]),u}(),x=function(){function e(){f(this,e)}return n(e,null,[{key:"log",value:function(){var e;(e=console).log.apply(e,arguments)}},{key:"warning",value:function(){var e;(e=console).warning.apply(e,arguments)}},{key:"error",value:function(){var e;(e=console).error.apply(e,arguments)}}]),e}(),v=function(){function t(e){f(this,t),this.conditions=e,this.offset=0,this.limit=1/0,this.index=null,this.order=1}return n(t,[{key:"match",value:function(e){return function e(t,n){try{for(var r in n)if(r===v.Command.AND){if(!Array.isArray(n[r]))throw p.invalidParams("Query syntax error with ".concat(r));for(var o in n[r])if(!e(t,n[r][o]))return!1}else if(r===v.Command.OR){if(!Array.isArray(n[r]))throw p.invalidParams("Query syntax error with ".concat(r));var i=0;for(var a in n[r])e(t,n[r][a])&&i++;if(0===i)return!1}else{var u=n[r];if("object"===s(u)&&u)for(var c in u)switch(c){case v.Command.GT:if("number"==typeof t[r]){if(!(t[r]>u[c]))return!1}else{if("string"!=typeof t[r])return!1;if(!(0<t[r].localeCompare(u[c])))return!1}break;case v.Command.GTE:if("number"==typeof t[r]){if(!(t[r]>=u[c]))return!1}else{if("string"!=typeof t[r])return!1;if(!(0<=t[r].localeCompare(u[c])))return!1}break;case v.Command.LT:if("number"==typeof t[r]){if(!(t[r]<u[c]))return!1}else{if("string"!=typeof t[r])return!1;if(!(t[r].localeCompare(u[c])<0))return!1}break;case v.Command.LTE:if("number"==typeof t[r]){if(!(t[r]<=u[c]))return!1}else{if("string"!=typeof t[r])return!1;if(!(t[r].localeCompare(u[c])<=0))return!1}break;case v.Command.EQ:if(t[r]!==u[c])return!1;break;case v.Command.NEQ:if(t[r]===u[c])return!1;break;case v.Command.IN:if(!Array.isArray(u[c]))throw p.invalidParams("Query syntax error with ".concat(r));if(!(0<=u[c].indexOf(t[r])))return!1;break;case v.Command.NOT_IN:if(!Array.isArray(u[c]))throw p.invalidParams("Query syntax error with ".concat(r));if(!(u[c].indexOf(t[r])<0))return!1;break;case v.Command.LIKE:if("string"!=typeof u[c])throw p.invalidParams("Query syntax error with ".concat(r));if(!(0<=u[c].indexOf(t[r])))return!1;break;case v.Command.NOT_LIKE:if("string"!=typeof u[c])throw p.invalidParams("Query syntax error with ".concat(r));if(!(u[c].indexOf(t[r])<0))return!1;break;case v.Command.REGEX:if(!(u[c]instanceof RegExp))throw p.invalidParams("Query syntax error with ".concat(r));if(!u[c].test(t[r]))return!1;break;case v.Command.WHERE:if("function"!=typeof u[c])throw p.invalidParams("Query syntax error with ".concat(r));if(!u[c](t[r]))return!1;break;default:return!1}else if(t[r]!==u)return!1}return!0}catch(e){return x.error(e.message),!1}}(e,this.conditions)}}],[{key:"Command",get:function(){return{AND:"/and",OR:"/or",GT:">",GTE:">=",LT:"<",LTE:"<=",EQ:"=",NEQ:"!=",IN:"/in",NOT_IN:"/nin",LIKE:"/like",NOT_LIKE:"/nlike",REGEX:"/regex",WHERE:"/where"}}}]),t}(),p=function(){function r(e,t){var n;return f(this,r),(n=u(this,o(r).call(this,e))).code=t,n}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&i(e,t)}(r,t(Error)),n(r,null,[{key:"immutableReadyState",value:function(){return new r("Can't change database after getting ready.",700010)}},{key:"databaseNotReady",value:function(){return new r("Database is not ready.",700011)}},{key:"kernelNotLoaded",value:function(){return new r("Database kernel is not loaded.",700012)}},{key:"invalidParams",value:function(e){return new r("Invalid parameters: ".concat(0<arguments.length&&void 0!==e?e:"unknown"),703e3)}}]),r}(),P="esdb-metadata",h=null,E=null,k=new(function(){function e(){return f(this,e),h||(E={name:"",version:1,store:new y,encryption:new m,schema:{},options:{},collection:{},error:null,state:e.State.INIT},h=this),h}var u,t;return n(e,[{key:"name",value:function(e){return E.error||("string"==typeof e&&e?this.isInit?E.name=e:E.error=p.immutableReadyState():E.error=p.invalidParams("esdb.name(".concat(e,")"))),this}},{key:"version",value:function(e){return E.error||("number"==typeof e&&0<e?this.isInit?E.version=e:E.error=p.immutableReadyState():E.error=p.invalidParams("esdb.version(".concat(e,")"))),this}},{key:"store",value:function(e){return E.error||(e instanceof y?this.isInit?E.store=e:E.error=p.immutableReadyState():E.error=p.invalidParams("esdb.store(".concat(e,")"))),this}},{key:"config",value:function(e){return E.error||("object"===s(e)&&e?this.isInit?E.options=e:E.error=p.immutableReadyState():E.error=p.invalidParams("esdb.config(".concat(e,")"))),this}},{key:"encryption",value:function(e){return E.error||(e instanceof m?this.isInit?E.encryption=e:E.error=p.immutableReadyState():E.error=p.invalidParams("esdb.encryption(".concat(e,")"))),this}},{key:"schema",value:function(e){if(!E.error){var t=e.name,n=e.model,r=e.key,o=e.indexes,i=void 0===o?[]:o,a=e.migrate,u=void 0===a?null:a;"string"==typeof t&&t&&"object"===s(n)&&n&&"string"==typeof r&&r&&Array.isArray(i)&&i.every(function(e){return Array.isArray(e)&&0<e.length&&e.every(function(e){return"string"==typeof e&&n.hasOwnProperty(e)})})&&("function"==typeof u||null===u)?this.isInit?E.schema[t]={model:n,key:r,indexes:i,migrate:u}:E.error=p.immutableReadyState():E.error=p.invalidParams("esdb.schema(".concat(e,")"))}return this}},{key:"build",value:(u=regeneratorRuntime.mark(function e(){var t,n,r,o,i,a,u,c,s,f,l,y,m,d,v,p,h,k,b;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(E.error){e.next=53;break}return e.prev=1,t=E.name,n=E.version,r=E.store,o=E.schema,e.next=5,r.init();case 5:return e.next=7,r.getItem(P);case 7:i=e.sent,a=null,u=!1,i&&i.version!==n&&(a=i.version,u=!0),c=new g({name:t,store:r,encryption:E.encryption,options:E.options}),e.t0=regeneratorRuntime.keys(o);case 13:if((e.t1=e.t0()).done){e.next=44;break}return s=e.t1.value,f="".concat("esdb-collection-").concat(s),l=o[s],y=l.model,m=l.key,d=l.indexes,v=l.migrate,p=new w({name:s,key:m,kernel:c}),e.next=20,r.getItem(f);case 20:if(!(h=e.sent)){e.next=39;break}if(!u){e.next=39;break}if(v)return e.next=26,p.getAll();e.next=38;break;case 26:k=e.sent,e.t2=regeneratorRuntime.keys(k);case 28:if((e.t3=e.t2()).done){e.next=38;break}return b=e.t3.value,e.next=32,v(a,k[b]);case 32:if(e.sent)return e.next=36,p.update(k[b]);e.next=36;break;case 36:e.next=28;break;case 38:h.key;case 39:return e.next=41,r.setItem(f,{model:y,key:m,indexes:d});case 41:E.collection[s]=p,e.next=13;break;case 44:return e.next=46,r.setItem(P,JSON.stringify({name:t,version:n,schema:o}));case 46:e.next=51;break;case 48:e.prev=48,e.t4=e.catch(1),x.error(e.t4.message);case 51:e.next=54;break;case 53:x.error(E.error.message);case 54:case"end":return e.stop()}},e,null,[[1,48]])}),t=function(){var e=this,a=arguments;return new Promise(function(t,n){var r=u.apply(e,a);function o(e){c(r,t,n,o,i,"next",e)}function i(e){c(r,t,n,o,i,"throw",e)}o(void 0)})},function(){return t.apply(this,arguments)})},{key:"collection",value:function(e){var t=null;return E.error||(this.isReady?"string"==typeof e&&E.collection.hasOwnProperty(e)&&E.collection[e]instanceof w?t=E.collection[e]:x.error(p.invalidParams("esdb.collection(".concat(e,")"))):x.error(p.databaseNotReady())),t}},{key:"isInit",get:function(){return E.state===e.State.INIT}},{key:"isReady",get:function(){return E.state===e.State.READY}}],[{key:"State",get:function(){return{INIT:"init",READY:"ready"}}}]),e}());e.EsdbEncryption=m,e.EsdbError=p,e.EsdbQuery=v,e.EsdbStore=y,e.default=k,Object.defineProperty(e,"__esModule",{value:!0})});