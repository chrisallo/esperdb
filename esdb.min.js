// esdb v1.0.0
!function(e,n){"object"==typeof exports&&"undefined"!=typeof module?n(exports):"function"==typeof define&&define.amd?define(["exports"],n):n((e=e||self).esdb={})}(this,function(e){"use strict";function m(e){return(m="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function c(e,n,t,r,a,o,i){try{var u=e[o](i),c=u.value}catch(e){return void t(e)}u.done?n(c):Promise.resolve(c).then(r,a)}function v(u){return function(){var e=this,i=arguments;return new Promise(function(n,t){var r=u.apply(e,i);function a(e){c(r,n,t,a,o,"next",e)}function o(e){c(r,n,t,a,o,"throw",e)}a(void 0)})}}function p(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}function r(e,n){for(var t=0;t<n.length;t++){var r=n[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function t(e,n,t){return n&&r(e.prototype,n),t&&r(e,t),e}function a(e){return(a=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function o(e,n){return(o=Object.setPrototypeOf||function(e,n){return e.__proto__=n,e})(e,n)}function i(e,n,t){return(i=function(){if("undefined"!=typeof Reflect&&Reflect.construct&&!Reflect.construct.sham){if("function"==typeof Proxy)return 1;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),1}catch(e){return}}}()?Reflect.construct:function(e,n,t){var r=[null];r.push.apply(r,n);var a=new(Function.bind.apply(e,r));return t&&o(a,t.prototype),a}).apply(null,arguments)}function n(e){var r="function"==typeof Map?new Map:void 0;return(n=function(e){if(null===e||(n=e,-1===Function.toString.call(n).indexOf("[native code]")))return e;var n;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==r){if(r.has(e))return r.get(e);r.set(e,t)}function t(){return i(e,arguments,a(this).constructor)}return t.prototype=Object.create(e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),o(t,e)})(e)}function u(e,n){return!n||"object"!=typeof n&&"function"!=typeof n?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):n}function s(e){return JSON.parse(JSON.stringify(e))}var l={},f=function(){function n(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:20;p(this,n),this.mockDelay=e}return t(n,[{key:"init",value:function(){return Promise.resolve()}},{key:"getItem",value:function(n){var t=this;return new Promise(function(e){setTimeout(function(){e(l[n]||null)},t.mockDelay)})}},{key:"setItem",value:function(n,t){var r=this;return new Promise(function(e){setTimeout(function(){l[n]=t,e(t)},r.mockDelay)})}},{key:"removeItem",value:function(t){var e=this;return new Promise(function(n){setTimeout(function(){var e=null;l.hasOwnProperty(t)&&(e=l[t],delete l[t]),n(e)},e.mockDelay)})}},{key:"clearAllItems",value:function(){var n=this;return new Promise(function(e){setTimeout(function(){l={},e()},n.mockDelay)})}}]),n}(),y=function(){function e(){p(this,e)}return t(e,[{key:"encrypt",value:function(e){return JSON.stringify(e)}},{key:"decrypt",value:function(e){return JSON.parse(e)}}]),e}(),P=function(){function s(e){var n=e.name,t=void 0===n?"":n,r=e.store,a=void 0===r?null:r,o=e.encryption,i=void 0===o?null:o,u=e.options,c=void 0===u?{}:u;p(this,s),this.name=t,this.store=a,this.encryption=i,this.config={blockSize:c.blockSize||64,batchSize:c.batchSize||128,batchInterval:c.batchInterval||200}}return t(s,[{key:"get",value:function(){return new Promise(function(e,n){})}},{key:"getAll",value:function(){return new Promise(function(e,n){})}},{key:"each",value:function(){return new Promise(function(e,n){})}},{key:"count",value:function(){return new Promise(function(e,n){})}},{key:"set",value:function(){return new Promise(function(e,n){})}},{key:"remove",value:function(){return new Promise(function(e,n){})}},{key:"clear",value:function(){return new Promise(function(e,n){})}}]),s}(),I=function(){function e(){p(this,e)}return t(e,null,[{key:"log",value:function(){var e;(e=console).log.apply(e,arguments)}},{key:"warning",value:function(){var e;(e=console).warning.apply(e,arguments)}},{key:"error",value:function(){var e;(e=console).error.apply(e,arguments)}}]),e}(),d=function(){function n(e){p(this,n),this.conditions=e}return t(n,[{key:"getRelatedColumns",value:function(){return[]}},{key:"match",value:function(e){return function e(n,t){try{for(var r in t)if(r===d.Command.AND){if(!Array.isArray(t[r]))throw h.invalidParams("Query syntax error with ".concat(r));for(var a in t[r])if(!e(n,t[r][a]))return!1}else if(r===d.Command.OR){if(!Array.isArray(t[r]))throw h.invalidParams("Query syntax error with ".concat(r));var o=0;for(var i in t[r])e(n,t[r][i])&&o++;if(0===o)return!1}else{var u=t[r];if("object"===m(u)&&u)for(var c in u)switch(c){case d.Command.GT:if("number"==typeof n[r]){if(!(n[r]>u[c]))return!1}else{if("string"!=typeof n[r])return!1;if(!(0<n[r].localeCompare(u[c])))return!1}break;case d.Command.GTE:if("number"==typeof n[r]){if(!(n[r]>=u[c]))return!1}else{if("string"!=typeof n[r])return!1;if(!(0<=n[r].localeCompare(u[c])))return!1}break;case d.Command.LT:if("number"==typeof n[r]){if(!(n[r]<u[c]))return!1}else{if("string"!=typeof n[r])return!1;if(!(n[r].localeCompare(u[c])<0))return!1}break;case d.Command.LTE:if("number"==typeof n[r]){if(!(n[r]<=u[c]))return!1}else{if("string"!=typeof n[r])return!1;if(!(n[r].localeCompare(u[c])<=0))return!1}break;case d.Command.EQ:if(n[r]!==u[c])return!1;break;case d.Command.NEQ:if(n[r]===u[c])return!1;break;case d.Command.IN:if(!Array.isArray(u[c]))throw h.invalidParams("Query syntax error with ".concat(r));if(!(0<=u[c].indexOf(n[r])))return!1;break;case d.Command.NOT_IN:if(!Array.isArray(u[c]))throw h.invalidParams("Query syntax error with ".concat(r));if(!(u[c].indexOf(n[r])<0))return!1;break;case d.Command.LIKE:if("string"!=typeof u[c])throw h.invalidParams("Query syntax error with ".concat(r));if(!(0<=u[c].indexOf(n[r])))return!1;break;case d.Command.NOT_LIKE:if("string"!=typeof u[c])throw h.invalidParams("Query syntax error with ".concat(r));if(!(u[c].indexOf(n[r])<0))return!1;break;case d.Command.REGEX:if(!(u[c]instanceof RegExp))throw h.invalidParams("Query syntax error with ".concat(r));if(!u[c].test(n[r]))return!1;break;case d.Command.WHERE:if("function"!=typeof u[c])throw h.invalidParams("Query syntax error with ".concat(r));if(!u[c](n[r]))return!1;break;default:return!1}else if(n[r]!==u)return!1}return!0}catch(e){return I.error(e.message),!1}}(e,this.conditions)}}],[{key:"Command",get:function(){return{AND:"/and",OR:"/or",GT:">",GTE:">=",LT:"<",LTE:"<=",EQ:"=",NEQ:"!=",IN:"/in",NOT_IN:"/nin",LIKE:"/like",NOT_LIKE:"/nlike",REGEX:"/regex",WHERE:"/where"}}}]),n}(),N=function(){function u(e){var n=e.collectionName,t=void 0===n?"":n,r=e.kernel,a=void 0===r?null:r,o=e.indexes,i=void 0===o?[]:o;p(this,u),this.collectionName=t,this.kernel=a,this.indexes=i}var n;return t(u,[{key:"indexToKey",value:function(e){return e.join(">")}},{key:"indexFromKey",value:function(e){return e.split(">")}},{key:"findBestIndexForQuery",value:function(e,n){var t=1<arguments.length&&void 0!==n?n:{};if(e instanceof d&&"object"===m(t)&&null!==t){var r=e.getRelatedColumns(),a=[];for(var o in this.indexes){var i=this.indexes[o].map(function(e){return e.replace(/^--/,"")}),u=0,c=1;for(var s in i){var l=i[s];0<=r.indexOf(l)?u+=c:c*=.2}0<i.length&&i[i.length-1]===t.orderBy&&(c+=2*Math.sqrt(i.length)/i.length),0<u&&a.push({index:this.indexes[o],score:u})}var f=a.sort(function(e,n){return n.score-e.score});return 0<f.length?f[0]:null}return null}},{key:"replace",value:(n=v(regeneratorRuntime.mark(function e(n){var t,r,a,o,i,u,c,s,l,f,m=this;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:for(t=[],r=[],a=function(e,n){return e.localeCompare(n)},o=this.indexes.map(function(e){return m.indexToKey(e)}).sort(a),i=n.map(function(e){return m.indexToKey(e)}).sort(a),c=u=0;u<o.length||c<i.length;)s=o[u]||null,l=i[c]||null,s&&l?0===(f=a(s,l))?(u++,c++):0<f?(t.push(l),c++):(r.push(s),u++):s?(r.push(s),u++):l&&(t.push(l),c++);this.indexes=n;case 9:case"end":return e.stop()}},e,this)})),function(e){return n.apply(this,arguments)})}]),u}(),h=function(){function r(e,n){var t;return p(this,r),(t=u(this,a(r).call(this,e))).code=n,t}return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(n&&n.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),n&&o(e,n)}(r,n(Error)),t(r,null,[{key:"immutableReadyState",value:function(){return new r("Can't change database after getting ready.",700010)}},{key:"databaseNotReady",value:function(){return new r("Database is not ready.",700011)}},{key:"kernelNotLoaded",value:function(){return new r("Database kernel is not loaded.",700012)}},{key:"invalidParams",value:function(e){return new r("Invalid parameters: ".concat(0<arguments.length&&void 0!==e?e:"unknown"),703e3)}},{key:"dataNotFound",value:function(){return new r("Data not found.",704e3)}},{key:"dataAlreadyExists",value:function(){return new r("Data already exists.",709e3)}}]),r}(),k=function(){function e(){p(this,e),this.queue=[],this.locked=!1}return t(e,[{key:"lock",value:function(e){var n=this;this.locked?this.queue.push(e):(this.locked=!0,e(function(){return n.unlock()}))}},{key:"unlock",value:function(){if(this.locked&&(this.locked=!1,0<this.queue.length)){var e=this.queue.shift();this.lock(e)}}}]),e}(),x=new WeakMap,E=function(){function f(e){var n=e.name,t=void 0===n?"":n,r=e.key,a=void 0===r?"":r,o=e.model,i=void 0===o?null:o,u=e.indexer,c=void 0===u?null:u,s=e.kernel,l=void 0===s?null:s;p(this,f),x.set(this,{name:t,key:a,model:i,indexer:c,kernel:l,mutex:new k})}return t(f,[{key:"get",value:function(o){var i=this;return new Promise(function(t,r){if("string"==typeof o){var e=x.get(i),a=e.kernel,n=e.mutex;a?n.lock(function(){var n=v(regeneratorRuntime.mark(function e(n){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.t0=t,e.next=4,a.get(i.name,o);case 4:e.t1=e.sent,(0,e.t0)(e.t1),e.next=11;break;case 8:e.prev=8,e.t2=e.catch(0),r(e.t2);case 11:return e.prev=11,n(),e.finish(11);case 14:case"end":return e.stop()}},e,null,[[0,8,11,14]])}));return function(e){return n.apply(this,arguments)}}()):r(h.kernelNotLoaded())}else r(h.invalidParams("collection.get(".concat(o,")")))})}},{key:"getAll",value:function(s,e){var l=this,f=1<arguments.length&&void 0!==e?e:{};return new Promise(function(o,i){if((s instanceof d||null===s)&&"object"===m(f)){var e=x.get(l),u=e.kernel,c=e.indexer,n=e.mutex;u?n.lock(function(){var n=v(regeneratorRuntime.mark(function e(n){var r,t,a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,!c.findBestIndexForQuery(s,f)){e.next=5;break}e.next=12;break;case 5:return r=[],e.next=8,u.each(l.name,function(){var t=v(regeneratorRuntime.mark(function e(n,t){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:s&&!s.match(t)||r.push(t);case 1:case"end":return e.stop()}},e)}));return function(e,n){return t.apply(this,arguments)}}());case 8:f.orderBy&&(t=f.orderBy.replace(/^--/,""),a=/^--/.test(f.orderBy),r=r.sort(function(e,n){return a?n[t]-e[t]:e[t]-n[t]})),f.offset&&(r=r.slice(f.offset)),f.limit&&(r=r.slice(0,f.limit)),o(r);case 12:e.next=17;break;case 14:e.prev=14,e.t0=e.catch(0),i(e.t0);case 17:return e.prev=17,n(),e.finish(17);case 20:case"end":return e.stop()}},e,null,[[0,14,17,20]])}));return function(e){return n.apply(this,arguments)}}()):i(h.kernelNotLoaded())}else i(h.invalidParams("collection.getAll()"))})}},{key:"count",value:function(i){var u=this;return new Promise(function(t,a){if(i instanceof d){var e=x.get(u),o=e.kernel,n=e.mutex;o?n.lock(function(){var n=v(regeneratorRuntime.mark(function e(n){var r;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,i)return r=0,e.next=5,o.each(u.name,function(){var t=v(regeneratorRuntime.mark(function e(n,t){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:i.match(t)&&r++;case 1:case"end":return e.stop()}},e)}));return function(e,n){return t.apply(this,arguments)}}());e.next=8;break;case 5:t(r),e.next=13;break;case 8:return e.t0=t,e.next=11,o.count(u.name);case 11:e.t1=e.sent,(0,e.t0)(e.t1);case 13:e.next=18;break;case 15:e.prev=15,e.t2=e.catch(0),a(e.t2);case 18:return e.prev=18,n(),e.finish(18);case 21:case"end":return e.stop()}},e,null,[[0,15,18,21]])}));return function(e){return n.apply(this,arguments)}}()):a(h.kernelNotLoaded())}else a(h.invalidParams("collection.count()"))})}},{key:"insert",value:function(o){var i=this;return new Promise(function(t,r){if("object"===m(o)&&null!==o&&o.hasOwnProperty(i.key)){var e=x.get(i),a=e.kernel,n=e.mutex;a?n.lock(function(){var n=v(regeneratorRuntime.mark(function e(n){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,a.get(i.name,o[i.key],o);case 3:if(e.sent){e.next=12;break}return e.t0=t,e.next=8,a.set(i.name,o[i.key],o);case 8:e.t1=e.sent,(0,e.t0)(e.t1),e.next=13;break;case 12:throw h.dataAlreadyExists();case 13:e.next=18;break;case 15:e.prev=15,e.t2=e.catch(0),r(e.t2);case 18:return e.prev=18,n(),e.finish(18);case 21:case"end":return e.stop()}},e,null,[[0,15,18,21]])}));return function(e){return n.apply(this,arguments)}}()):r(h.kernelNotLoaded())}else r(h.invalidParams("collection.insert(".concat(o,")")))})}},{key:"upsert",value:function(o){var i=this;return new Promise(function(t,r){if("object"===m(o)&&null!==o&&o.hasOwnProperty(i.key)){var e=x.get(i),a=e.kernel,n=e.mutex;a?n.lock(function(){var n=v(regeneratorRuntime.mark(function e(n){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.t0=t,e.next=4,a.set(i.name,o[i.key],o);case 4:e.t1=e.sent,(0,e.t0)(e.t1),e.next=11;break;case 8:e.prev=8,e.t2=e.catch(0),r(e.t2);case 11:return e.prev=11,n(),e.finish(11);case 14:case"end":return e.stop()}},e,null,[[0,8,11,14]])}));return function(e){return n.apply(this,arguments)}}()):r(h.kernelNotLoaded())}else r(h.invalidParams("collection.upsert(".concat(o,")")))})}},{key:"update",value:function(o){var i=this;return new Promise(function(t,r){if("object"===m(o)&&null!==o&&o.hasOwnProperty(i.key)){var e=x.get(i),a=e.kernel,n=e.mutex;a?n.lock(function(){var n=v(regeneratorRuntime.mark(function e(n){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,a.get(i.name,o[i.key],o);case 3:if(e.sent)return e.t0=t,e.next=8,a.set(i.name,o[i.key],o);e.next=12;break;case 8:e.t1=e.sent,(0,e.t0)(e.t1),e.next=13;break;case 12:throw h.dataNotFound();case 13:e.next=18;break;case 15:e.prev=15,e.t2=e.catch(0),r(e.t2);case 18:return e.prev=18,n(),e.finish(18);case 21:case"end":return e.stop()}},e,null,[[0,15,18,21]])}));return function(e){return n.apply(this,arguments)}}()):r(h.kernelNotLoaded())}else r(h.invalidParams("collection.update(".concat(o,")")))})}},{key:"remove",value:function(o){var i=this;return new Promise(function(t,r){if("string"==typeof o){var e=x.get(i),a=e.kernel,n=e.mutex;a?n.lock(function(){var n=v(regeneratorRuntime.mark(function e(n){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.t0=t,e.next=4,a.remove(i.name,o);case 4:e.t1=e.sent,(0,e.t0)(e.t1),e.next=11;break;case 8:e.prev=8,e.t2=e.catch(0),r(e.t2);case 11:return e.prev=11,n(),e.finish(11);case 14:case"end":return e.stop()}},e,null,[[0,8,11,14]])}));return function(e){return n.apply(this,arguments)}}()):r(h.kernelNotLoaded())}else r(h.invalidParams("collection.remove(".concat(o,")")))})}},{key:"updateIf",value:function(i,u){var c=this;return new Promise(function(t,r){if("object"===m(i)&&null!==i&&u instanceof d){var e=x.get(c),o=e.kernel,n=e.mutex;o?n.lock(function(){var n=v(regeneratorRuntime.mark(function e(n){var a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,a=[],e.next=4,o.each(c.name,function(){var t=v(regeneratorRuntime.mark(function e(n,t){var r;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!u.match(t)){e.next=5;break}for(r in i)t[r]=i[r];return e.next=4,o.set(c.name,n,t);case 4:a.push(t);case 5:case"end":return e.stop()}},e)}));return function(e,n){return t.apply(this,arguments)}}());case 4:t(a),e.next=10;break;case 7:e.prev=7,e.t0=e.catch(0),r(e.t0);case 10:return e.prev=10,n(),e.finish(10);case 13:case"end":return e.stop()}},e,null,[[0,7,10,13]])}));return function(e){return n.apply(this,arguments)}}()):r(h.kernelNotLoaded())}else r(h.invalidParams("collection.updateIf()"))})}},{key:"removeIf",value:function(i){var u=this;return new Promise(function(t,a){if(i instanceof d){var e=x.get(u),o=e.kernel,n=e.mutex;o?n.lock(function(){var n=v(regeneratorRuntime.mark(function e(n){var r;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,r=[],e.next=4,o.each(u.name,function(){var t=v(regeneratorRuntime.mark(function e(n,t){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(i.match(t))return e.next=3,o.remove(u.name,n);e.next=4;break;case 3:r.push(t);case 4:case"end":return e.stop()}},e)}));return function(e,n){return t.apply(this,arguments)}}());case 4:t(r),e.next=10;break;case 7:e.prev=7,e.t0=e.catch(0),a(e.t0);case 10:return e.prev=10,n(),e.finish(10);case 13:case"end":return e.stop()}},e,null,[[0,7,10,13]])}));return function(e){return n.apply(this,arguments)}}()):a(h.kernelNotLoaded())}else a(h.invalidParams("collection.removeIf()"))})}},{key:"clear",value:function(){var o=this;return new Promise(function(t,r){var e=x.get(o),a=e.kernel,n=e.mutex;a?n.lock(function(){var n=v(regeneratorRuntime.mark(function e(n){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,a.clear(o.name);case 3:t(),e.next=9;break;case 6:e.prev=6,e.t0=e.catch(0),r(e.t0);case 9:return e.prev=9,n(),e.finish(9);case 12:case"end":return e.stop()}},e,null,[[0,6,9,12]])}));return function(e){return n.apply(this,arguments)}}()):r(h.kernelNotLoaded())})}},{key:"name",get:function(){return x.get(this).name}},{key:"key",get:function(){return x.get(this).key}},{key:"model",get:function(){var e=x.get(this).model;return s(e)}},{key:"indexes",get:function(){var e=x.get(this).indexer;return s(e.indexes)}}]),f}(),O="esdb-metadata",g=null,S=null,b=new(function(){function e(){return p(this,e),g||(S={name:"",version:1,store:new f,encryption:new y,schema:{},options:{},collection:{},error:null,state:e.State.INIT},g=this),g}var n;return t(e,[{key:"name",value:function(e){return S.error||("string"==typeof e&&e?this.isInit?S.name=e:S.error=h.immutableReadyState():S.error=h.invalidParams("esdb.name(".concat(e,")"))),this}},{key:"version",value:function(e){return S.error||("number"==typeof e&&0<e?this.isInit?S.version=e:S.error=h.immutableReadyState():S.error=h.invalidParams("esdb.version(".concat(e,")"))),this}},{key:"store",value:function(e){return S.error||(e instanceof f?this.isInit?S.store=e:S.error=h.immutableReadyState():S.error=h.invalidParams("esdb.store(".concat(e,")"))),this}},{key:"config",value:function(e){return S.error||("object"===m(e)&&e?this.isInit?S.options=e:S.error=h.immutableReadyState():S.error=h.invalidParams("esdb.config(".concat(e,")"))),this}},{key:"encryption",value:function(e){return S.error||(e instanceof y?this.isInit?S.encryption=e:S.error=h.immutableReadyState():S.error=h.invalidParams("esdb.encryption(".concat(e,")"))),this}},{key:"schema",value:function(e){if(!S.error){var n=e.name,t=e.model,r=e.key,a=e.indexes,o=void 0===a?[]:a,i=e.migrate,u=void 0===i?null:i;"string"==typeof n&&n&&"object"===m(t)&&t&&"string"==typeof r&&r&&Array.isArray(o)&&o.every(function(e){return Array.isArray(e)&&0<e.length&&e.every(function(e){return"string"==typeof e&&t.hasOwnProperty(e)})})&&("function"==typeof u||null===u)?this.isInit?S.schema[n]={model:t,key:r,indexes:o,migrate:u}:S.error=h.immutableReadyState():S.error=h.invalidParams("esdb.schema(".concat(e,")"))}return this}},{key:"build",value:(n=v(regeneratorRuntime.mark(function e(){var n,t,r,a,o,i,u,c,s,l,f,m,v,p,y,d,h,k,x,g,b,w,R;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(S.error){e.next=66;break}return e.prev=1,n=S.name,t=S.version,r=S.store,a=S.schema,e.next=5,r.init();case 5:return e.next=7,r.getItem(O);case 7:o=e.sent,i=null,u=!1,o&&o.version!==t&&(i=o.version,u=!0),c=new P({name:n,store:r,encryption:S.encryption,options:S.options}),e.t0=regeneratorRuntime.keys(a);case 13:if((e.t1=e.t0()).done){e.next=57;break}s=e.t1.value,l="".concat("esdb-collection-").concat(s),f=a[s],m=f.model,v=f.key,p=f.indexes,y=f.migrate,d=!1,e.t2=regeneratorRuntime.keys(p);case 19:if((e.t3=e.t2()).done){e.next=27;break}if(h=e.t3.value,1===(k=p[h]).length&&k[0]===v)return d=!0,e.abrupt("break",27);e.next=25;break;case 25:e.next=19;break;case 27:return d||p.unshift([v]),e.next=30,r.getItem(l);case 30:if(x=e.sent,g=new N({collectionName:s,kernel:c,indexes:x?x.indexes:p}),b=new E({name:s,key:v,model:m,indexer:g,kernel:c}),!x){e.next=52;break}if(!u){e.next=52;break}if(y)return e.next=38,b.getAll();e.next=50;break;case 38:w=e.sent,e.t4=regeneratorRuntime.keys(w);case 40:if((e.t5=e.t4()).done){e.next=50;break}return R=e.t5.value,e.next=44,y(i,w[R]);case 44:if(e.sent)return e.next=48,b.update(w[R]);e.next=48;break;case 48:e.next=40;break;case 50:return e.next=52,g.replace(p);case 52:return e.next=54,r.setItem(l,{model:m,key:v,indexes:p});case 54:S.collection[s]=b,e.next=13;break;case 57:return e.next=59,r.setItem(O,JSON.stringify({name:n,version:t,schema:a}));case 59:e.next=64;break;case 61:e.prev=61,e.t6=e.catch(1),I.error(e.t6.message);case 64:e.next=67;break;case 66:I.error(S.error.message);case 67:case"end":return e.stop()}},e,null,[[1,61]])})),function(){return n.apply(this,arguments)})},{key:"collection",value:function(e){var n=null;return S.error||(this.isReady?"string"==typeof e&&S.collection.hasOwnProperty(e)&&S.collection[e]instanceof E?n=S.collection[e]:I.error(h.invalidParams("esdb.collection(".concat(e,")"))):I.error(h.databaseNotReady())),n}},{key:"isInit",get:function(){return S.state===e.State.INIT}},{key:"isReady",get:function(){return S.state===e.State.READY}}],[{key:"State",get:function(){return{INIT:"init",READY:"ready"}}}]),e}());e.EsdbEncryption=y,e.EsdbError=h,e.EsdbQuery=d,e.EsdbStore=f,e.default=b,Object.defineProperty(e,"__esModule",{value:!0})});