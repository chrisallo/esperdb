// esdb v1.0.0
!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?r(exports):"function"==typeof define&&define.amd?define(["exports"],r):r((e=e||self).esdb={})}(this,function(e){"use strict";function f(e){return(f="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function o(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}function t(e,r){for(var n=0;n<r.length;n++){var t=r[n];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(e,t.key,t)}}function n(e,r,n){return r&&t(e.prototype,r),n&&t(e,n),e}function i(e){return(i=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function a(e,r){return(a=Object.setPrototypeOf||function(e,r){return e.__proto__=r,e})(e,r)}function u(e,r,n){return(u=function(){if("undefined"!=typeof Reflect&&Reflect.construct&&!Reflect.construct.sham){if("function"==typeof Proxy)return 1;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),1}catch(e){return}}}()?Reflect.construct:function(e,r,n){var t=[null];t.push.apply(t,r);var o=new(Function.bind.apply(e,t));return n&&a(o,n.prototype),o}).apply(null,arguments)}function r(e){var t="function"==typeof Map?new Map:void 0;return(r=function(e){if(null===e||(r=e,-1===Function.toString.call(r).indexOf("[native code]")))return e;var r;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==t){if(t.has(e))return t.get(e);t.set(e,n)}function n(){return u(e,arguments,i(this).constructor)}return n.prototype=Object.create(e.prototype,{constructor:{value:n,enumerable:!1,writable:!0,configurable:!0}}),a(n,e)})(e)}function c(e,r){return!r||"object"!=typeof r&&"function"!=typeof r?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):r}var s={},l=function(){function e(){o(this,e)}return n(e,[{key:"init",value:function(){return Promise.resolve()}},{key:"getItem",value:function(r){return new Promise(function(e){e(s[r]||null)})}},{key:"setItem",value:function(r,n){return new Promise(function(e){e(s[r]=n)})}},{key:"removeItem",value:function(n){return new Promise(function(e){var r=null;s.hasOwnProperty(n)&&(r=s[n],delete s[n]),e(r)})}},{key:"clearAllItems",value:function(){return new Promise(function(e){s={},e()})}}]),e}(),y=function(){function e(){o(this,e)}return n(e,[{key:"encrypt",value:function(e){return JSON.stringify(e)}},{key:"decrypt",value:function(e){return JSON.parse(e)}}]),e}(),m=function(){function t(e){var r=e.name,n=void 0===r?"":r;o(this,t),this.name=n}return n(t,[{key:"get",value:function(){return new Promise(function(e,r){})}},{key:"getAll",value:function(){return new Promise(function(e,r){})}},{key:"count",value:function(){return new Promise(function(e,r){})}},{key:"insert",value:function(){return new Promise(function(e,r){})}},{key:"upsert",value:function(){return new Promise(function(e,r){})}},{key:"update",value:function(){return new Promise(function(e,r){})}},{key:"remove",value:function(){return new Promise(function(e,r){})}},{key:"updateIf",value:function(){return new Promise(function(e,r){})}},{key:"removeIf",value:function(){return new Promise(function(e,r){})}},{key:"clear",value:function(){return new Promise(function(e,r){})}}]),t}(),d=function(){function e(){o(this,e)}return n(e,null,[{key:"log",value:function(){var e;(e=console).log.apply(e,arguments)}},{key:"warning",value:function(){var e;(e=console).warning.apply(e,arguments)}},{key:"error",value:function(){var e;(e=console).error.apply(e,arguments)}}]),e}(),p=function(){function r(e){o(this,r),this.conditions=e,this.offset=0,this.limit=1/0,this.index=null,this.order=1}return n(r,[{key:"match",value:function(e){return function e(r,n){try{for(var t in n)if(t===p.Command.AND){if(!Array.isArray(n[t]))throw v.invalidParams("Query syntax error with ".concat(t));for(var o in n[t])if(!e(r,n[t][o]))return!1}else if(t===p.Command.OR){if(!Array.isArray(n[t]))throw v.invalidParams("Query syntax error with ".concat(t));var i=0;for(var a in n[t])e(r,n[t][a])&&i++;if(0===i)return!1}else{var u=n[t];if("object"===f(u)&&u)for(var c in u)switch(c){case p.Command.GT:if("number"==typeof r[t]){if(!(r[t]>u[c]))return!1}else{if("string"!=typeof r[t])return!1;if(!(0<r[t].localeCompare(u[c])))return!1}break;case p.Command.GTE:if("number"==typeof r[t]){if(!(r[t]>=u[c]))return!1}else{if("string"!=typeof r[t])return!1;if(!(0<=r[t].localeCompare(u[c])))return!1}break;case p.Command.LT:if("number"==typeof r[t]){if(!(r[t]<u[c]))return!1}else{if("string"!=typeof r[t])return!1;if(!(r[t].localeCompare(u[c])<0))return!1}break;case p.Command.LTE:if("number"==typeof r[t]){if(!(r[t]<=u[c]))return!1}else{if("string"!=typeof r[t])return!1;if(!(r[t].localeCompare(u[c])<=0))return!1}break;case p.Command.EQ:if(r[t]!==u[c])return!1;break;case p.Command.NEQ:if(r[t]===u[c])return!1;break;case p.Command.IN:if(!Array.isArray(u[c]))throw v.invalidParams("Query syntax error with ".concat(t));if(!(0<=u[c].indexOf(r[t])))return!1;break;case p.Command.NOT_IN:if(!Array.isArray(u[c]))throw v.invalidParams("Query syntax error with ".concat(t));if(!(u[c].indexOf(r[t])<0))return!1;break;case p.Command.LIKE:if("string"!=typeof u[c])throw v.invalidParams("Query syntax error with ".concat(t));if(!(0<=u[c].indexOf(r[t])))return!1;break;case p.Command.NOT_LIKE:if("string"!=typeof u[c])throw v.invalidParams("Query syntax error with ".concat(t));if(!(u[c].indexOf(r[t])<0))return!1;break;case p.Command.REGEX:if(!(u[c]instanceof RegExp))throw v.invalidParams("Query syntax error with ".concat(t));if(!u[c].test(r[t]))return!1;break;case p.Command.WHERE:if("function"!=typeof u[c])throw v.invalidParams("Query syntax error with ".concat(t));if(!u[c](r[t]))return!1;break;default:return!1}else if(r[t]!==u)return!1}return!0}catch(e){return d.error(e.message),!1}}(e,this.conditions)}}],[{key:"Command",get:function(){return{AND:"/and",OR:"/or",GT:">",GTE:">=",LT:"<",LTE:"<=",EQ:"=",NEQ:"!=",IN:"/in",NOT_IN:"/nin",LIKE:"/like",NOT_LIKE:"/nlike",REGEX:"/regex",WHERE:"/where"}}}]),r}(),v=function(){function t(e,r){var n;return o(this,t),(n=c(this,i(t).call(this,e))).code=r,n}return function(e,r){if("function"!=typeof r&&null!==r)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(r&&r.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),r&&a(e,r)}(t,r(Error)),n(t,null,[{key:"immutableReadyState",value:function(){return new t("Can't change database after getting ready.",700010)}},{key:"databaseNotReady",value:function(){return new t("Database is not ready.",700011)}},{key:"invalidParams",value:function(e){return new t("Invalid parameters: ".concat(0<arguments.length&&void 0!==e?e:"unknown"),703e3)}}]),t}(),h=null,b=null,w=new(function(){function e(){return o(this,e),h||(b={name:"",version:1,baseStore:new l,encryption:new y,schema:{},collection:{},error:null,state:e.State.INIT},h=this),h}return n(e,[{key:"name",value:function(e){return b.error||("string"==typeof e&&e?this.isInit?b.name=e:b.error=v.immutableReadyState():b.error=v.invalidParams("esdb.name(".concat(e,")"))),this}},{key:"version",value:function(e){return b.error||("number"==typeof e&&0<e?this.isInit?b.version=e:b.error=v.immutableReadyState():b.error=v.invalidParams("esdb.version(".concat(e,")"))),this}},{key:"baseStore",value:function(e){return b.error||(e instanceof l?this.isInit?b.baseStore=e:b.error=v.immutableReadyState():b.error=v.invalidParams("esdb.baseStore(".concat(e,")"))),this}},{key:"encryption",value:function(e){return b.error||(e instanceof y?this.isInit?b.encryption=e:b.error=v.immutableReadyState():b.error=v.invalidParams("esdb.encryption(".concat(e,")"))),this}},{key:"schema",value:function(e){if(!b.error){var r=e.name,n=e.model,t=e.key,o=e.indexes,i=void 0===o?[]:o,a=e.migrate,u=void 0===a?null:a;"string"==typeof r&&r&&"object"===f(n)&&n&&"string"==typeof t&&t&&Array.isArray(i)&&i.every(function(e){return Array.isArray(e)&&0<e.length&&e.every(function(e){return"string"==typeof e&&n.hasOwnProperty(e)})})&&("function"==typeof u||null===u)?this.isInit?b.schema[r]={model:n,key:t,indexes:i,migrate:u}:b.error=v.immutableReadyState():b.error=v.invalidParams("esdb.schema(".concat(e,")"))}return this}},{key:"build",value:function(e){var n=0<arguments.length&&void 0!==e?e:{};return new Promise(function(e,r){if(b.error)d.error(b.error.message),r(b.error);else n.batchSize,n.batchInterval,n.cacheBlockLimit,n.cacheBlockFlush})}},{key:"collection",value:function(e){var r=null;return b.error||(this.isReady?"string"==typeof e&&b.collection.hasOwnProperty(e)&&b.collection[e]instanceof m?r=b.collection[e]:d.error(v.invalidParams("esdb.collection(".concat(e,")"))):d.error(v.databaseNotReady())),r}},{key:"isInit",get:function(){return b.state===e.State.INIT}},{key:"isReady",get:function(){return b.state===e.State.READY}}],[{key:"State",get:function(){return{INIT:"init",READY:"ready"}}}]),e}());e.EsdbBaseStore=l,e.EsdbEncryption=y,e.EsdbError=v,e.EsdbQuery=p,e.default=w,Object.defineProperty(e,"__esModule",{value:!0})});