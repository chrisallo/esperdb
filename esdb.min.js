// esdb v1.0.0
!function(e,n){"object"==typeof exports&&"undefined"!=typeof module?n(exports):"function"==typeof define&&define.amd?define(["exports"],n):n((e=e||self).esdb={})}(this,function(e){"use strict";function f(e){return(f="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function a(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}function t(e,n){for(var r=0;r<n.length;r++){var t=n[r];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(e,t.key,t)}}function r(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}function o(e){return(o=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function i(e,n){return(i=Object.setPrototypeOf||function(e,n){return e.__proto__=n,e})(e,n)}function u(e,n,r){return(u=function(){if("undefined"!=typeof Reflect&&Reflect.construct&&!Reflect.construct.sham){if("function"==typeof Proxy)return 1;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),1}catch(e){return}}}()?Reflect.construct:function(e,n,r){var t=[null];t.push.apply(t,n);var o=new(Function.bind.apply(e,t));return r&&i(o,r.prototype),o}).apply(null,arguments)}function n(e){var t="function"==typeof Map?new Map:void 0;return(n=function(e){if(null===e||(n=e,-1===Function.toString.call(n).indexOf("[native code]")))return e;var n;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==t){if(t.has(e))return t.get(e);t.set(e,r)}function r(){return u(e,arguments,o(this).constructor)}return r.prototype=Object.create(e.prototype,{constructor:{value:r,enumerable:!1,writable:!0,configurable:!0}}),i(r,e)})(e)}function c(e,n){return!n||"object"!=typeof n&&"function"!=typeof n?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):n}var s={},l=function(){function e(){a(this,e)}return r(e,[{key:"init",value:function(){return Promise.resolve()}},{key:"getItem",value:function(n){return new Promise(function(e){e(s[n]||null)})}},{key:"setItem",value:function(n,r){return new Promise(function(e){e(s[n]=r)})}},{key:"removeItem",value:function(r){return new Promise(function(e){var n=null;s.hasOwnProperty(r)&&(n=s[r],delete s[r]),e(n)})}},{key:"clearAllItems",value:function(){return new Promise(function(e){s={},e()})}}]),e}(),y=function(){function e(){a(this,e)}return r(e,[{key:"encrypt",value:function(e){return JSON.stringify(e)}},{key:"decrypt",value:function(e){return JSON.parse(e)}}]),e}(),m=function(){function i(e){var n=e.name,r=void 0===n?"":n,t=e.key,o=void 0===t?"":t;a(this,i),this.name=r,this.key=o}return r(i,[{key:"_init",value:function(){return new Promise(function(e,n){})}},{key:"get",value:function(){return new Promise(function(e,n){})}},{key:"getAll",value:function(){return new Promise(function(e,n){})}},{key:"count",value:function(){return new Promise(function(e,n){})}},{key:"insert",value:function(){return new Promise(function(e,n){})}},{key:"upsert",value:function(){return new Promise(function(e,n){})}},{key:"update",value:function(){return new Promise(function(e,n){})}},{key:"remove",value:function(){return new Promise(function(e,n){})}},{key:"updateIf",value:function(){return new Promise(function(e,n){})}},{key:"removeIf",value:function(){return new Promise(function(e,n){})}},{key:"clear",value:function(){return new Promise(function(e,n){})}}]),i}(),d=function(){function e(){a(this,e)}return r(e,null,[{key:"log",value:function(){var e;(e=console).log.apply(e,arguments)}},{key:"warning",value:function(){var e;(e=console).warning.apply(e,arguments)}},{key:"error",value:function(){var e;(e=console).error.apply(e,arguments)}}]),e}(),p=function(){function n(e){a(this,n),this.conditions=e,this.offset=0,this.limit=1/0,this.index=null,this.order=1}return r(n,[{key:"match",value:function(e){return function e(n,r){try{for(var t in r)if(t===p.Command.AND){if(!Array.isArray(r[t]))throw v.invalidParams("Query syntax error with ".concat(t));for(var o in r[t])if(!e(n,r[t][o]))return!1}else if(t===p.Command.OR){if(!Array.isArray(r[t]))throw v.invalidParams("Query syntax error with ".concat(t));var i=0;for(var a in r[t])e(n,r[t][a])&&i++;if(0===i)return!1}else{var u=r[t];if("object"===f(u)&&u)for(var c in u)switch(c){case p.Command.GT:if("number"==typeof n[t]){if(!(n[t]>u[c]))return!1}else{if("string"!=typeof n[t])return!1;if(!(0<n[t].localeCompare(u[c])))return!1}break;case p.Command.GTE:if("number"==typeof n[t]){if(!(n[t]>=u[c]))return!1}else{if("string"!=typeof n[t])return!1;if(!(0<=n[t].localeCompare(u[c])))return!1}break;case p.Command.LT:if("number"==typeof n[t]){if(!(n[t]<u[c]))return!1}else{if("string"!=typeof n[t])return!1;if(!(n[t].localeCompare(u[c])<0))return!1}break;case p.Command.LTE:if("number"==typeof n[t]){if(!(n[t]<=u[c]))return!1}else{if("string"!=typeof n[t])return!1;if(!(n[t].localeCompare(u[c])<=0))return!1}break;case p.Command.EQ:if(n[t]!==u[c])return!1;break;case p.Command.NEQ:if(n[t]===u[c])return!1;break;case p.Command.IN:if(!Array.isArray(u[c]))throw v.invalidParams("Query syntax error with ".concat(t));if(!(0<=u[c].indexOf(n[t])))return!1;break;case p.Command.NOT_IN:if(!Array.isArray(u[c]))throw v.invalidParams("Query syntax error with ".concat(t));if(!(u[c].indexOf(n[t])<0))return!1;break;case p.Command.LIKE:if("string"!=typeof u[c])throw v.invalidParams("Query syntax error with ".concat(t));if(!(0<=u[c].indexOf(n[t])))return!1;break;case p.Command.NOT_LIKE:if("string"!=typeof u[c])throw v.invalidParams("Query syntax error with ".concat(t));if(!(u[c].indexOf(n[t])<0))return!1;break;case p.Command.REGEX:if(!(u[c]instanceof RegExp))throw v.invalidParams("Query syntax error with ".concat(t));if(!u[c].test(n[t]))return!1;break;case p.Command.WHERE:if("function"!=typeof u[c])throw v.invalidParams("Query syntax error with ".concat(t));if(!u[c](n[t]))return!1;break;default:return!1}else if(n[t]!==u)return!1}return!0}catch(e){return d.error(e.message),!1}}(e,this.conditions)}}],[{key:"Command",get:function(){return{AND:"/and",OR:"/or",GT:">",GTE:">=",LT:"<",LTE:"<=",EQ:"=",NEQ:"!=",IN:"/in",NOT_IN:"/nin",LIKE:"/like",NOT_LIKE:"/nlike",REGEX:"/regex",WHERE:"/where"}}}]),n}(),v=function(){function t(e,n){var r;return a(this,t),(r=c(this,o(t).call(this,e))).code=n,r}return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(n&&n.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),n&&i(e,n)}(t,n(Error)),r(t,null,[{key:"immutableReadyState",value:function(){return new t("Can't change database after getting ready.",700010)}},{key:"databaseNotReady",value:function(){return new t("Database is not ready.",700011)}},{key:"invalidParams",value:function(e){return new t("Invalid parameters: ".concat(0<arguments.length&&void 0!==e?e:"unknown"),703e3)}}]),t}(),h=null,b=null,k=new(function(){function e(){return a(this,e),h||(b={name:"",version:1,store:new l,encryption:new y,schema:{},collection:{},error:null,state:e.State.INIT},h=this),h}return r(e,[{key:"name",value:function(e){return b.error||("string"==typeof e&&e?this.isInit?b.name=e:b.error=v.immutableReadyState():b.error=v.invalidParams("esdb.name(".concat(e,")"))),this}},{key:"version",value:function(e){return b.error||("number"==typeof e&&0<e?this.isInit?b.version=e:b.error=v.immutableReadyState():b.error=v.invalidParams("esdb.version(".concat(e,")"))),this}},{key:"store",value:function(e){return b.error||(e instanceof l?this.isInit?b.store=e:b.error=v.immutableReadyState():b.error=v.invalidParams("esdb.store(".concat(e,")"))),this}},{key:"encryption",value:function(e){return b.error||(e instanceof y?this.isInit?b.encryption=e:b.error=v.immutableReadyState():b.error=v.invalidParams("esdb.encryption(".concat(e,")"))),this}},{key:"schema",value:function(e){if(!b.error){var n=e.name,r=e.model,t=e.key,o=e.indexes,i=void 0===o?[]:o,a=e.migrate,u=void 0===a?null:a;"string"==typeof n&&n&&"object"===f(r)&&r&&"string"==typeof t&&t&&Array.isArray(i)&&i.every(function(e){return Array.isArray(e)&&0<e.length&&e.every(function(e){return"string"==typeof e&&r.hasOwnProperty(e)})})&&("function"==typeof u||null===u)?this.isInit?b.schema[n]={model:r,key:t,indexes:i,migrate:u}:b.error=v.immutableReadyState():b.error=v.invalidParams("esdb.schema(".concat(e,")"))}return this}},{key:"build",value:function(e){var a=0<arguments.length&&void 0!==e?e:{};return new Promise(function(e,n){if(b.error)d.error(b.error.message),n(b.error);else{a.batchSize,a.batchInterval,a.cacheBlockLimit,a.cacheBlockFlush;var r=[];for(var t in b.schema)if(!b.collections[t]){var o=b.schema[t].key||"id",i=b.collections[t]=new m({name:t,key:o});r.push(i._init())}}})}},{key:"collection",value:function(e){var n=null;return b.error||(this.isReady?"string"==typeof e&&b.collection.hasOwnProperty(e)&&b.collection[e]instanceof m?n=b.collection[e]:d.error(v.invalidParams("esdb.collection(".concat(e,")"))):d.error(v.databaseNotReady())),n}},{key:"isInit",get:function(){return b.state===e.State.INIT}},{key:"isReady",get:function(){return b.state===e.State.READY}}],[{key:"State",get:function(){return{INIT:"init",READY:"ready"}}}]),e}());e.EsdbEncryption=y,e.EsdbError=v,e.EsdbQuery=p,e.EsdbStore=l,e.default=k,Object.defineProperty(e,"__esModule",{value:!0})});